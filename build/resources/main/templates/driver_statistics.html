<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Driver Statistics</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Driver Statistics</h1>
        <a href="/dispatcher" class="btn btn-secondary">Back to Dispatcher Panel</a>
    </div>

    <div th:if="${driver}">
        <h2 th:text="${driver.driverName} + ' (' + ${driver.driverId} + ')'">Driver Name (ID)</h2>
    </div>
    <div th:unless="${driver}">
        <h2>Driver not found</h2>
    </div>

    <div th:if="${driver}">
        <h3>Event Graph</h3>
        <canvas id="eventChart" width="400" height="200"></canvas>

        <h3 class="mt-4">Event Log</h3>
        <table class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Timestamp</th>
                    <th>Event Type</th>
                    <th>Duration (seconds)</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="event : ${events}">
                    <td th:text="${#temporals.format(event.startTime, 'yyyy-MM-dd HH:mm:ss')}">Timestamp</td>
                    <td th:text="${event.eventType}">Event Type</td>
                    <td th:text="${event.durationSeconds}">Duration</td>
                </tr>
                <tr th:if="${#lists.isEmpty(events)}">
                    <td colspan="3" class="text-center">No events recorded for this driver.</td>
                </tr>
            </tbody>
        </table>
    </div>

</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const events = /*[[${events}]]*/ [];
    const driver = /*[[${driver}]]*/ null;

    if (driver && events && events.length > 0) {
        const ctx = document.getElementById('eventChart').getContext('2d');
        
        // Map event types to numerical values for the Y-axis
        const eventTypeMapping = {
            'DISTRACTION': 1,
            'DROWSINESS': 2,
            // Add other event types here if needed
            'NORMAL': 0 // Optional: represent normal state
        };

        const chartData = {
            labels: events.map(event => event.startTime), // Use startTime directly
            datasets: [{
                label: 'Driver Events (1: Distraction, 2: Drowsiness)',
                data: events.map(event => ({
                    x: event.startTime, // Use startTime for x-axis
                    y: eventTypeMapping[event.eventType] !== undefined ? eventTypeMapping[event.eventType] : -1 // Map type to Y value, -1 for unknown
                })),
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                // Use stepped line to better represent discrete events
                stepped: true, 
            }]
        };

        const config = {
            type: 'line',
            data: chartData,
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute', // Adjust time unit as needed (e.g., 'hour', 'day')
                            tooltipFormat: 'YYYY-MM-DD HH:mm:ss',
                            displayFormats: {
                                minute: 'HH:mm'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Event Type'
                        },
                        ticks: {
                           // Define explicit ticks for event types
                           callback: function(value, index, values) {
                                switch(value) {
                                    case 0: return 'Normal';
                                    case 1: return 'Distraction';
                                    case 2: return 'Drowsiness';
                                    default: return ''; // Handle other values or hide them
                                }
                           },
                           stepSize: 1 // Ensure ticks are placed at integer values
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                const eventType = Object.keys(eventTypeMapping).find(key => eventTypeMapping[key] === context.parsed.y);
                                if (eventType) {
                                     label += eventType;
                                } else {
                                    label += 'Unknown Event';
                                }
                                // Optionally add duration or other info to tooltip
                                // const event = events[context.dataIndex];
                                // label += ` (Duration: ${event.durationSeconds}s)`;
                                return label;
                            }
                        }
                    }
                }
            }
        };

        const eventChart = new Chart(ctx, config);
    } else {
        // Optional: Display a message if there's no data for the chart
        const chartCanvas = document.getElementById('eventChart');
        if (chartCanvas) {
             const ctx = chartCanvas.getContext('2d');
             ctx.font = '16px Arial';
             ctx.textAlign = 'center';
             ctx.fillText('No event data available to display chart.', chartCanvas.width / 2, chartCanvas.height / 2);
        }
       
    }
    /*]]>*/
</script>

</body>
</html>
