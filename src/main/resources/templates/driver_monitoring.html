<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Driver Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Basic styling for video and notification */
        #videoContainer {
            position: relative;
            width: 640px; /* Match performance requirements */
            height: 480px;
            margin: auto;
            border: 1px solid black;
        }
        #videoElement {
            width: 100%;
            height: 100%;
        }
        #notificationArea {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            min-width: 150px; /* Ensure alert is visible */
        }
    </style>
</head>
<body>
<div class="container mt-3">
    <h2 th:text="'Monitoring Driver: ' + ${driverName} + ' (ID: ' + ${driverId} + ')'">Monitoring Driver</h2>

    <!-- Notification Area -->
    <div id="notificationArea">
        <!-- Notifications will be injected here by JavaScript -->
        <div class="alert alert-secondary" role="alert">
            Status: Initializing...
        </div>
    </div>

    <!-- Video Feed Area -->
    <div id="videoContainer">
        <video id="videoElement" autoplay playsinline></video>
    </div>

    <!-- Exit Button -->
    <div class="mt-3 text-center">
        <a th:href="@{/driver/exit}" class="btn btn-danger">Exit Session</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- JavaScript for Camera Access and Notifications ---

    const videoElement = document.getElementById('videoElement');
    const notificationArea = document.getElementById('notificationArea');
    let currentDriverState = null; // To track the current state and avoid redundant updates

    // Function to show notifications based on driver state
    function showNotification(state) {
        if (state === currentDriverState) {
            return; // No change, do nothing
        }
        currentDriverState = state;

        let alertClass = 'alert-secondary';
        let message = 'Status: Unknown';

        switch (state) {
            case 'NORMAL':
                alertClass = 'alert-success';
                message = 'Status: Normal';
                break;
            case 'DISTRACTED':
                alertClass = 'alert-warning';
                message = 'Warning: Distracted!';
                break;
            case 'DROWSY':
                alertClass = 'alert-danger';
                message = 'Warning: Drowsy!';
                break;
        }

        notificationArea.innerHTML = `
            <div class="alert ${alertClass}" role="alert">
                ${message}
            </div>`;
    }

    // Function to start the camera
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 480 }, // Request specific resolution
                audio: false
            });
            videoElement.srcObject = stream;
            showNotification('NORMAL'); // Assume normal state initially

            // Placeholder for starting frame analysis (from TASK_05)
            // setInterval(analyzeFrame, 1000); // Analyze frame every second

        } catch (err) {
            console.error("Error accessing camera: ", err);
            notificationArea.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    Error: Could not access camera. Please check permissions.
                </div>`;
        }
    }

    // Placeholder for frame analysis function (to be implemented in TASK_05)
    // function analyzeFrame() {
    //     // 1. Capture frame from videoElement
    //     // 2. Send frame to backend or process in JS (depending on TASK_05 implementation)
    //     // 3. Get driver state (NORMAL, DISTRACTED, DROWSY)
    //     // 4. Call showNotification(newState);
    //     console.log('Analyzing frame...');
    //     // Example: Simulate state change
    //     // const states = ['NORMAL', 'DISTRACTED', 'DROWSY'];
    //     // const randomState = states[Math.floor(Math.random() * states.length)];
    //     // showNotification(randomState);
    // }

    // Start the camera when the page loads
    window.onload = startCamera;

</script>
</body>
</html>
